================================================================================
  Google reCAPTCHA v3 для NGCMS
  Версия 0.8.0 (18 января 2026)
================================================================================

ОПИСАНИЕ
--------
Плагин обеспечивает защиту форм сайта от интернет-ботов и спама с помощью
Google reCAPTCHA v3. Работает незаметно для пользователей - без капчи и
кликов по картинкам.

Плагин автоматически защищает:
  • Форму регистрации пользователей
  • Форму отправки комментариев (плагин comments)
  • Формы обратной связи (плагин feedback)

ЧТО НОВОГО В ВЕРСИИ 0.8.0
--------------------------
✓ Улучшенная безопасность - все данные обрабатываются через sanitize()
✓ Централизованное логирование - все события записываются в лог
✓ Визуальные уведомления - пользователи видят ng-toasts при блокировке
✓ Расширенная диагностика - детальное логирование всех ошибок
✓ Мониторинг - отслеживание score и статистики блокировок

Полный список изменений см. в файле CHANGELOG.md


СИСТЕМНЫЕ ТРЕБОВАНИЯ
---------------------
  • PHP 8.0 или выше
  • NGCMS 1.0.0 или выше
  • Плагин ng-helpers v0.2.1+ (обязательно должен быть активирован!)
  • PHP расширение cURL или разрешён allow_url_fopen
  • Аккаунт Google для получения ключей reCAPTCHA v3


УСТАНОВКА
---------
1. Скопируйте папку плагина в директорию /engine/plugins/

2. Войдите в админ-панель NGCMS

3. Перейдите в раздел "Плагины" → "Управление плагинами"

4. Найдите плагин "Google reCAPTCHA v3" и нажмите "Активировать"

5. ВАЖНО: Убедитесь, что плагин ng-helpers активирован!


ПОЛУЧЕНИЕ КЛЮЧЕЙ RECAPTCHA
---------------------------
1. Перейдите на страницу регистрации:
   https://www.google.com/recaptcha/admin/create

2. Заполните форму:
   • Название сайта: любое (например: "Мой сайт")
   • Тип reCAPTCHA: выберите "reCAPTCHA v3"
   • Домены: укажите домен вашего сайта (без http://)

3. Нажмите "Отправить"

4. Скопируйте полученные ключи:
   • Ключ сайта (Site Key)
   • Секретный ключ (Secret Key)


НАСТРОЙКА ПЛАГИНА
------------------
1. В админ-панели перейдите:
   Плагины → Управление плагинами → Google reCAPTCHA v3 → Настройки

2. Вставьте полученные ключи:
   • Ключ сайта - вставьте Site Key
   • Секретный ключ - вставьте Secret Key

3. Настройте параметры:

   Нижний порог оценки (score):
   • 0.1-0.3 - очень мягкий фильтр (пропустит почти всех)
   • 0.4-0.6 - сбалансированный (рекомендуется 0.5)
   • 0.7-0.9 - строгий фильтр (может блокировать реальных пользователей)

   Проверять только гостей:
   • Да - авторизованные пользователи не проходят проверку (рекомендуется)
   • Нет - проверка для всех пользователей

   Встраивать JavaScript API:
   • Да - автоматически добавляет скрипты на все страницы (рекомендуется)
   • Нет - управление скриптами вручную

   Встраивать JavaScript из шаблона:
   • Да - для работы с модальными окнами (рекомендуется)
   • Нет - стандартный режим

4. Нажмите "Сохранить"


НАСТРОЙКА ШАБЛОНОВ
-------------------
Для работы плагина необходимо добавить скрытое поле в формы:

1. Форма регистрации:
   Файл: /templates/ВАШ_ШАБЛОН/registration.tpl

   Добавьте ПЕРЕД закрывающим тегом </form>:
   <input type="hidden" name="g-recaptcha-response" value="" />

2. Форма комментариев:
   Файл: /templates/ВАШ_ШАБЛОН/plugins/comments/comments.form.tpl

   Добавьте ПЕРЕД закрывающим тегом </form>:
   <input type="hidden" name="g-recaptcha-response" value="" />

   Если используете AJAX отправку, добавьте в секции <script>:
   cajax.setVar('g-recaptcha-response', form['g-recaptcha-response'].value);

3. Форма обратной связи:
   Файл: /templates/ВАШ_ШАБЛОН/plugins/feedback/site.form.tpl

   Добавьте ПЕРЕД закрывающим тегом </form>:
   <input type="hidden" name="g-recaptcha-response" value="" />


ПРОВЕРКА РАБОТЫ
---------------
После настройки на вашем сайте:

1. В правом нижнем углу страницы появится маленький значок reCAPTCHA

2. Попробуйте отправить форму (регистрацию или комментарий)

3. Если всё настроено правильно:
   • Форма отправится без проблем
   • В логах появится запись о успешной верификации

4. Для проверки блокировки ботов:
   • Удалите скрытое поле из формы
   • Попробуйте отправить - должна появиться ошибка


ЛОГИРОВАНИЕ
-----------
С версии 0.8.0 плагин автоматически записывает все события:

• Info - успешные верификации с указанием score
• Warning - блокировки пользователей (низкий score, нет токена)
• Error - технические ошибки (API недоступен, cURL/JSON ошибки)

Формат логов: ng-grecaptcha: [контекст] - [детали]

Просмотр логов:
  • Через стандартные средства NGCMS
  • Через плагин xsyslog (если установлен)
  • В файлах логов на сервере


ОТЛАДКА ПРОБЛЕМ
---------------
Проблема: Плагин блокирует реальных пользователей

Решение:
  1. Снизьте порог score до 0.3-0.4 в настройках
  2. Проверьте логи - там указан score каждой попытки
  3. Включите опцию "Проверять только гостей"
  4. Убедитесь, что ключи reCAPTCHA корректны

Проблема: Плагин не блокирует ботов

Решение:
  1. Увеличьте порог score до 0.6-0.7
  2. Проверьте, что скрытое поле добавлено во ВСЕ формы
  3. Убедитесь, что JavaScript API загружается (смотрите код страницы)
  4. Проверьте консоль браузера на ошибки JavaScript

Проблема: Ошибка "Undefined constant tpl_site"

Решение:
  1. Обновите ядро NGCMS до версии 1.0.0+
  2. Убедитесь, что файл /engine/includes/inc/extras.inc.php обновлён
  3. Очистите кэш: /engine/cache/

Проблема: Ошибка "Unable to add global tpl_url"

Решение:
  1. Обновите файл /engine/core.php
  2. Проверьте, что используется mergeGlobals() вместо addGlobal()
  3. Очистите кэш Twig: /engine/cache/twig/

Проблема: Форма отправляется, но капча не проверяется

Решение:
  1. Проверьте, что плагин ng-helpers активирован
  2. Убедитесь, что скрытое поле <input name="g-recaptcha-response"> добавлено
  3. Проверьте логи на наличие ошибок API Google
  4. Проверьте доступность API (curl/allow_url_fopen)


КОНСОЛЬ АДМИНИСТРИРОВАНИЯ GOOGLE
---------------------------------
Для просмотра статистики и аналитики:
https://www.google.com/recaptcha/admin

В консоли вы можете:
  • Просматривать статистику запросов
  • Анализировать score пользователей
  • Управлять доменами
  • Изменять настройки безопасности


БЕЗОПАСНОСТЬ
------------
Плагин использует современные практики безопасности:

✓ Все входные данные обрабатываются через sanitize()
✓ Защита от XSS и SQL-инъекций
✓ Безопасная передача токенов через POST
✓ Валидация на стороне сервера
✓ Защита от undefined переменных
✓ Централизованное логирование всех событий


ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ
-------------------------
Документация:
  • README.md - полная документация на русском
  • CHANGELOG.md - история изменений
  • Официальный сайт NGCMS: http://ngcms.ru/
  • Форум поддержки: http://ngcms.ru/forum/

GitHub репозиторий:
  https://github.com/russsiq/ng-grecaptcha

Документация Google reCAPTCHA:
  https://developers.google.com/recaptcha/docs/v3


ЛИЦЕНЗИЯ
--------
MIT License - свободное использование и модификация
См. файл LICENSE для деталей


ПОДДЕРЖКА
---------
Вопросы и проблемы:
  • Форум NGCMS: http://ngcms.ru/forum/
  • GitHub Issues: https://github.com/russsiq/ng-grecaptcha/issues

Автор оригинального плагина: Рустам Гимранов
Обновление ng-helpers: 18 января 2026


================================================================================
Спасибо за использование Google reCAPTCHA v3 для NGCMS!
================================================================================
