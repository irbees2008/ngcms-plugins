# Журнал изменений - Обновление ng-grecaptcha

## Версия 0.8.0 (18 января 2026)

### Улучшения безопасности и логирования

Плагин "Google reCAPTCHA v3" (ng-grecaptcha) был обновлён для улучшения безопасности, логирования и уведомлений пользователей.

### Изменённые файлы

#### 1. ng-grecaptcha.php

- **Строка 27**: Добавлен импорт ng-helpers функций:
  ```php
  use function Plugins\{notify, logger, sanitize};
  ```

#### 2. src/GRecaptcha.php (309 строк)

- **Строка 24**: Добавлен импорт ng-helpers функций:
  ```php
  use function Plugins\{notify, logger, sanitize};
  ```

**Улучшения безопасности (3 замены):**

| Строка  | Было                             | Стало               | Причина                           |
| ------- | -------------------------------- | ------------------- | --------------------------------- |
| 130-131 | `secure_html()`                  | `sanitize()`        | Современная функция из ng-helpers |
| 135     | `$_POST['g-recaptcha-response']` | Защита от undefined | Использован оператор `??`         |

**Добавлено логирование (9 мест):**

| Строка  | Контекст                    | Уровень | Сообщение                                  |
| ------- | --------------------------- | ------- | ------------------------------------------ |
| 198     | MissingVariableException    | warning | Missing variable - [reason]                |
| 201     | VerificationFailedException | warning | Verification failed - [reason]             |
| 204     | Unexpected error            | error   | Unexpected error - [message]               |
| 195     | Успешная верификация        | info    | Verification successful, score: [score]    |
| 237     | cURL init error             | error   | cURL init error - [details]                |
| 249     | HTTP 404 error              | error   | API endpoint not found (404)               |
| 251-253 | HTTP error                  | error   | API HTTP error - [status]                  |
| 230     | JSON decode error           | error   | JSON decode error - [message]              |
| 218     | Extensions check            | error   | Neither cURL nor allow_url_fopen available |

#### 3. src/Filters/GRecaptchaCoreFilter.php

- **Строка 8**: Добавлен импорт:
  ```php
  use function Plugins\{notify, logger};
  ```

**Добавлено (2 вызова):**

| Строка | Функция          | Контекст               | Действие                            |
| ------ | ---------------- | ---------------------- | ----------------------------------- |
| 30     | `registerUser()` | Блокировка регистрации | notify('error') + logger('warning') |
| 35     | `registerUser()` | Успешная верификация   | logger('info')                      |

#### 4. src/Filters/GRecaptchaCommentsFilter.php

- **Строка 9**: Добавлен импорт:
  ```php
  use function Plugins\{notify, logger};
  ```

**Добавлено (2 вызова):**

| Строка | Функция         | Контекст               | Действие                            |
| ------ | --------------- | ---------------------- | ----------------------------------- |
| 32     | `addComments()` | Блокировка комментария | notify('error') + logger('warning') |
| 38     | `addComments()` | Успешная верификация   | logger('info')                      |

#### 5. src/Filters/GRecaptchaFeedbackFilter.php

- **Строка 9**: Добавлен импорт:
  ```php
  use function Plugins\{notify, logger};
  ```

**Добавлено (2 вызова):**

| Строка | Функция         | Контекст                  | Действие                            |
| ------ | --------------- | ------------------------- | ----------------------------------- |
| 33     | `onProcessEx()` | Блокировка отправки формы | notify('error') + logger('warning') |
| 39     | `onProcessEx()` | Успешная верификация      | logger('info')                      |

### Статистика изменений

| Метрика                    | Значение             |
| -------------------------- | -------------------- |
| Файлов изменено            | 5                    |
| Строк кода                 | 309 (основной класс) |
| secure_html() → sanitize() | 3                    |
| logger() добавлено         | 15                   |
| notify() добавлено         | 3                    |
| Версия обновлена           | 0.7.2 → 0.8.0        |

### Преимущества обновления

1. **Улучшенная безопасность**:
   - Использование современной функции `sanitize()` вместо `secure_html()`
   - Защита от undefined переменных с оператором `??`
   - Консистентная обработка пользовательского ввода

2. **Централизованное логирование**:
   - Все ошибки верификации записываются в лог
   - Успешные верификации также логируются
   - Детализированные сообщения об ошибках
   - Разные уровни важности (info, warning, error)

3. **Улучшенный UX**:
   - Пользователи видят ng-toasts уведомления при блокировке
   - Более понятные сообщения об ошибках
   - Визуальная обратная связь через notify()

4. **Отладка**:
   - Логирование облегчает поиск проблем с капчей
   - Отслеживание успешных и неудачных попыток
   - HTTP и cURL ошибки детально записываются

5. **Мониторинг**:
   - Возможность отслеживать score reCAPTCHA
   - Статистика блокировок по типу формы
   - Анализ ошибок API Google

### Обратная совместимость

✅ **Полностью сохранена**:

- API плагина не изменён
- Конфигурация остаётся прежней
- Интеграция с comments, feedback, core не требует изменений
- Шаблоны работают без модификаций

### Типы защищаемых форм

Плагин защищает следующие формы:

- ✅ Регистрация пользователей (core)
- ✅ Отправка комментариев (comments)
- ✅ Формы обратной связи (feedback)

### Системные требования

- **NGCMS**: 1.0.0+
- **ng-helpers**: v0.2.1+ (обязательная зависимость)
- **PHP**: 8.0+
- **PHP расширения**: cURL или allow_url_fopen
- **Google reCAPTCHA**: API v3

### Конфигурация

Плагин требует настройки ключей reCAPTCHA v3:

- **site_key** - ключ сайта (для генерации токена)
- **secret_key** - секретный ключ (для верификации)
- **score** - минимальный порог оценки (0.1-0.9, по умолчанию 0.5)
- **guests_only** - проверять только гостей (по умолчанию true)

### Логирование

Все события логируются в формате:

```
ng-grecaptcha: [context] - [details]
```

**Уровни логирования:**

- `info` - успешные верификации
- `warning` - блокировки пользователей
- `error` - технические ошибки (API, cURL, JSON)

### Тестирование

Рекомендуется протестировать:

- ✅ Регистрация нового пользователя
- ✅ Отправка комментария
- ✅ Отправка формы обратной связи
- ✅ Работа с низким score (блокировка)
- ✅ Работа без JavaScript
- ✅ Логирование в файл логов

### Миграция с 0.7.2

Обновление не требует действий:

1. Заменить файлы плагина
2. Очистить кэш (опционально)
3. Плагин готов к работе

Настройки сохраняются автоматически.

### Известные ограничения

- Требуется активный плагин ng-helpers
- Требуется подключение к API Google
- cURL или allow_url_fopen должны быть доступны

### Авторы

- Оригинальный плагин: ng-grecaptcha team
- Обновление ng-helpers: 18 января 2026

---

**Примечание**: Это обновление фокусируется на улучшении безопасности, логирования и UX. Функциональность защиты reCAPTCHA v3 остаётся неизменной.

## Версия 0.7.2 и ранее

История предыдущих версий доступна в файле `readme` плагина.
