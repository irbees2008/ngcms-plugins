## Защита форм сайта от интернет-ботов с Google reCAPTCHA v3
**Версия**: 0.8.0 (18 января 2026)
Предназначен для плагинов `comments`, `feedback`, а также для формы регистрации пользователей на сайте.
Плагин запрашивает у сервиса Google оценку действий пользователя без его участия для блокирования отправки форм ботами, которые чаще всего спамят.
### Что нового в версии 0.8.0
- ✅ **Улучшенная безопасность**: Использование современной функции `sanitize()` для обработки всех входных данных
- ✅ **Централизованное логирование**: Все события верификации записываются через `logger()` с разными уровнями важности
- ✅ **Визуальные уведомления**: Пользователи видят ng-toasts уведомления при блокировке через `notify()`
- ✅ **Расширенная диагностика**: Детальное логирование HTTP, cURL и JSON ошибок для упрощения отладки
- ✅ **Мониторинг**: Возможность отслеживать score reCAPTCHA и статистику блокировок
  Подробности см. в [CHANGELOG.md](CHANGELOG.md)
### Системные требования
Перед использованием плагина вам необходимо убедиться, что ваш сервер соответствует следующим требованиям:
- PHP >= 8.0
- NGCMS >= 1.0.0
- [russsiq/ng-helpers](https://github.com/russsiq/ng-helpers) >= 0.2.1
- cURL extension или allow_url_fopen включен
  > Плагин **ng-helpers** должен быть обязательно включен и активирован.
### Подключение
> Перед обновлением плагина, отключите его в панели управлении. По желанию, старую версию также можно удалить с сервера.
>
> Те же самые манипуляции относятся и к старой версии плагина [ggg_recaptcha](http://ngcms.ru/forum/viewtopic.php?pid=44202#p44202).
> Плагин использует кодировку UTF-8. Для подключения вы можете просто [скачать плагин](https://codeload.github.com/russsiq/ng-grecaptcha/zip/master).
Либо воспользуйтесь менеджером Composer:
```bash
composer require russsiq/ng-grecaptcha:dev-master
```
### Настройка
1.  Перед использованием плагина зарегистрируйтесь и получите Ключ и Секретный ключ reCAPTCHA v3 [здесь](https://www.google.com/recaptcha/admin/create).
1.  Активируйте плагин `ng-grecaptcha` в админ. панели.
1.  Вставьте Ключ и Секретный ключ в соответствующие поля.
1.  Настройте минимальный порог оценки (score) от 0.1 до 0.9 (по умолчанию 0.5).
1.  Выберите, проверять только гостей или всех пользователей.
1.  Никаких дополнительных действий с плагином не требуется.
    Теперь на вашем сайте в правом нижнем углу информационный блок от reCAPTCHA.
    При использовании опции **Встраивать на страницу файл JavaScript из шаблона**, вы можете отслеживать действия пользователей, разграничивая их в [консоли администрирования](https://www.google.com/recaptcha/admin). Для этого необходимо к каждой из форм добавлять соответствующий идентификатор.
### Логирование
С версии 0.8.0 плагин автоматически логирует все события:
- **Info**: Успешные верификации с указанием score
- **Warning**: Блокировки пользователей (низкий score, отсутствие токена)
- **Error**: Технические ошибки (API недоступен, cURL/JSON ошибки)
  Все логи записываются в формате: `ng-grecaptcha: [context] - [details]`
  Вы можете просматривать логи через стандартные средства NGCMS или через плагин `xsyslog`.
  Например, для формы регистрации пользователей это может выглядеть так:
```html
<!-- \templates\ВАШ_ШАБЛОН\registration.tpl -->
<form id="register_user" ...>
  <!-- Остальной код формы -->
</form>
```
### Использование
#### Плагин `comments`
Для использования в плагине `comments`, отредактируйте шаблон формы, добавив скрытое поле перед закрывающим тегом `</form>`:
```html
<!-- \templates\ВАШ_ШАБЛОН\plugins\comments\comments.form.tpl -->
<input type="hidden" name="g-recaptcha-response" value="" />
```
В том случае, если вы используете технологию AJAX для отправки комментариев, то вам необходимо добавить значение поля ввода капчи до того, как будет отправлен AJAX запрос вашим JavaScript.
Например, в этом же шаблоне добавить в секции `script` после `[not-logged] ... [/not-logged]`:
```javascript
cajax.setVar("g-recaptcha-response", form["g-recaptcha-response"].value);
```
#### Плагин `feedback`
Для использования в плагине `feedback`, отредактируйте шаблон формы, добавив скрытое поле перед закрывающим тегом `</form>`:
```html
<!-- \templates\ВАШ_ШАБЛОН\plugins\feedback\site.form.tpl -->
<input type="hidden" name="g-recaptcha-response" value="" />
```
#### Регистрационная форма
Для использования в форме регистрации пользователей, отредактируйте шаблон формы, добавив скрытое поле перед закрывающим тегом `</form>`:
```html
<!-- \templates\ВАШ_ШАБЛОН\registration.tpl -->
<input type="hidden" name="g-recaptcha-response" value="" />
```
#### Формы в модальных окнах
Для использования в формах модальных окон, отредактируйте шаблон формы, добавив скрытое поле перед закрывающим тегом `</form>`:
```html
<input type="hidden" name="g-recaptcha-response" value="" />
```
### Безопасность
Плагин использует современные практики безопасности:
- Все входные данные обрабатываются через `sanitize()`
- Защита от XSS и SQL-инъекций
- Безопасная передача токенов через POST
- Валидация на стороне сервера
- Защита от undefined переменных
### Отладка
Если плагин блокирует легитимных пользователей:
1. Проверьте score в настройках (попробуйте снизить до 0.3-0.4)
2. Проверьте логи для анализа причин блокировки
3. Убедитесь, что ключи reCAPTCHA корректны
4. Проверьте доступность API Google (cURL/allow_url_fopen)
   Если плагин не блокирует ботов:
5. Увеличьте score до 0.6-0.7
6. Проверьте, что скрытое поле добавлено во все формы
7. Убедитесь, что JavaScript API загружается корректно
### Поддержка
- [Официальная документация NGCMS](http://ngcms.ru/)
- [Форум NGCMS](http://ngcms.ru/forum/)
- [GitHub Issues](https://github.com/russsiq/ng-grecaptcha/issues)
### Лицензия
## `ng-grecaptcha` - программное обеспечение с открытым исходным кодом, распространяющееся по лицензии [MIT](https://choosealicense.com/licenses/mit/).
**Последнее обновление**: 18 января 2026 (версия 0.8.0)
