# Исправления безопасности в плагине Comments
## Критические исправления:
### 1. SQL Injection
- Добавлена валидация всех входных параметров
- Использование db_squote() для всех SQL запросов
- Оптимизация запросов (выборка только нужных полей)
### 2. Защита от прямого доступа
- Заменен die() на throw Exception для корректной обработки ошибок
- Добавлены проверки существования файлов перед include
### 3. Криптографическая безопасность
- Заменен MD5 на SHA256 для Gravatar
- Использование random_int() вместо rand()
- Добавлен HttpOnly флаг для cookies
### 4. Валидация входных данных
- Проверка isset() для всех $_REQUEST переменных
- Валидация числовых параметров
- Инициализация переменных перед использованием
### 5. Обработка ошибок
- Добавлена обработка ошибок в install/uninstall
- Проверка результатов выполнения функций
- Корректная обработка исключений
### 6. Оптимизация производительности
- Кэширование результатов pluginGetVariable()
- Замена array_push() на прямое присваивание
- Оптимизация SQL запросов
### 7. Улучшение кода
- Перевод комментариев на русский язык
- Исправление опечаток
- Улучшение читаемости кода
- Использование языковых констант
## Исправление ошибки 403 при добавлении комментариев:
### Проблема:
Ошибка 403 "Доступ запрещён" при попытке добавить комментарий
### Решение:
1. Создан альтернативный обработчик через `/engine/actions/comments_add.php`
2. Добавлен fallback URL в случае проблем с плагиновой маршрутизацией
3. Улучшена проверка методов запросов
4. Добавлена диагностика через `test_comments.php`
### Проверка работы:
1. Откройте `test_comments.php` в браузере для диагностики
2. Убедитесь, что плагин активен в админ-панели
3. Проверьте права доступа к файлам плагина (должны быть 644)
4. Убедитесь, что .htaccess настроен правильно
## Рекомендации по дальнейшему использованию:
1. Регулярно обновляйте плагин
2. Используйте HTTPS для всех соединений
3. Настройте правильные права доступа к файлам
4. Регулярно проверяйте логи на подозрительную активность
5. Используйте современные версии PHP (7.4+)
6. Мониторьте работу комментариев через логи Apache
